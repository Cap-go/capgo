name: Run tests

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
  workflow_call: # Allow this workflow to be called by other workflows

permissions:
  contents: read
  actions: write

env:
  DENO_DIR: my_cache_directory

jobs:
  test_all:
    runs-on: ubuntu-latest
    name: Run tests
    steps:
      - name: Cache Deno dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.DENO_DIR }}
          key: my_cache_key
      - name: Checkout capgo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Setup bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: latest
      - name: Check for typos
        uses: crate-ci/typos@9066e9940a8a05b98fb4733c62a726f83c9e57f8 # v1.43.3
      - name: Show bun version
        run: bun --version
      - name: Show capgo version
        run: bunx @capgo/cli@latest -v
      - name: Check for console statements
        run: |
          if grep -r --exclude="logging.ts" --exclude=".env" --exclude=".env.*" "console\." supabase/functions/; then
            echo "❌ Found console statements in supabase/functions directory, use cloudlog instead"
            exit 1
          else
            echo "✅ No console statements found in supabase/functions directory"
          fi
      - name: Install dependencies
        run: bun install
      # - name: Install playwright
      #   run: bunx playwright install
      - name: Lint
        run: bun lint && bun lint:backend
      - name: Typecheck
        run: bun typecheck
      # TODO: enable I18n linting when the issue they have with npm not found is fixed
      # - name: Lint I18n
      #   run: bunx @inlang/cli lint --project project.inlang
      - name: Install Supabase CLI
        uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1
        with:
          version: latest
      - name: Show Supabase CLI version
        run: supabase --version
      - name: Run Supabase Start
        run: supabase start -x imgproxy,studio,mailpit,realtime,postgres-meta,supavisor,studio,logflare,vector,realtime
      - name: Run Supabase Test DB
        run: supabase test db
      - name: Lint SQL
        run: supabase db lint -s public --fail-on warning
      - uses: JarvusInnovations/background-action@2428e7b970a846423095c79d43f759abf979a635 # v1
        name: Bootstrap Edge server
        with:
          run: supabase functions serve &
          wait-on: |
            http-get://127.0.0.1:54321/functions/v1/ok
          # IMPORTANT: to use environment variables in wait-on, you must use this form: ${{ env.VAR }}
          # See wait-on section below for all resource types and prefixes

          tail: stderr,stdout # true = stderr,stdout
          # This will allow you to monitor the progress live

          log-output-resume: stderr,stdout
          # Eliminates previously output stderr log entries from post-run output

          wait-for: 1m

          log-output: stderr,stdout # same as true

          log-output-if: true
          # failure = exit-early or timeout

          working-directory: .
      - name: Run all backend and CLI tests
        run: bun run test:all
      - uses: JarvusInnovations/background-action@2428e7b970a846423095c79d43f759abf979a635 # v1
        name: Start Cloudflare Workers for testing
        with:
          run: |
            chmod +x scripts/start-cloudflare-workers.sh
            ./scripts/start-cloudflare-workers.sh
          wait-on: |
            http-get://127.0.0.1:8787/ok
            http-get://127.0.0.1:8788/ok
            http-get://127.0.0.1:8789/ok
          tail: stderr,stdout
          log-output-resume: stderr,stdout
          wait-for: 2m
          log-output: stderr,stdout
          log-output-if: true
          working-directory: .
      - name: Run Cloudflare Workers backend tests
        run: bun run test:cloudflare:backend
      # - name: Run playwright tests
      #   run: bun run test:front
