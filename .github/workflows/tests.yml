name: Run tests

on:
  push:
    branches:
      - 'main'

jobs:
  test_base_sql:
    runs-on: ubuntu-latest	
    name: "Run test"
    steps:
      - name: "Checkout capgo"
        uses: actions/checkout@v4
      - name: Install Supabase CLI
        with:
          version: 1.176.10
        uses: supabase/setup-cli@v1
      - name: üçú Prepare Supabase ALPHA
        run: supabase link --project-ref aucsybvnhavogdmzwtcw
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_TOKEN }}
      - name: Run Supabase Start
        run: ENV=local supabase start
      - run: supabase test db
      - uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x
      - name: "Start minio"
        run: npm run minio:start && npm run minio:seed
      - run: deno test --allow-all supabase/functions/tests/* --env=supabase/.env.test --import-map=supabase/functions/import_map.json
