<script setup lang="ts">
import { Capacitor } from '@capacitor/core'
import { ref } from 'vue'
import { useI18n } from 'vue-i18n'
import { useRouter } from 'vue-router'
import IconBack from '~icons/material-symbols/arrow-back-ios-rounded'
import IconMenu from '~icons/material-symbols/menu-rounded'
import { useDisplayStore } from '~/stores/display'
import Banner from './Banner.vue'

const props = defineProps({
  sidebarOpen: {
    type: Boolean,
    default: false,
  },
})

defineEmits(['toggleSidebar'])
const isMobile = ref(Capacitor.isNativePlatform())

const router = useRouter()

const displayStore = useDisplayStore()
function back() {
  if (window.history.length > 2)
    router.back()
  else
    router.push(displayStore.defaultBack)
}
const { t } = useI18n()
</script>

<template>
  <header class="bg-slate-100 backdrop-blur-xl dark:bg-slate-900">
    <div class="px-2 lg:px-6 sm:px-4">
      <div class="relative flex items-center justify-between h-16 -mb-px">
        <!-- Header: Left side -->
        <div class="flex items-center space-x-4">
          <div v-if="displayStore.NavTitle && isMobile" class="pr-2">
            <button
              class="flex p-2 rounded-sm hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-500 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              :aria-label="t('button-back')"
              @click="back()"
            >
              <IconBack class="w-6 h-6 fill-current" />
              <span class="hidden md:block">{{ t('button-back') }}</span>
            </button>
          </div>
          <!-- Hamburger button -->
          <button
            class="text-slate-500 lg:hidden dark:text-white hover:text-slate-600 dark:hover:text-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-md p-1"
            aria-controls="sidebar"
            :aria-expanded="props.sidebarOpen"
            :aria-label="props.sidebarOpen ? t('close-sidebar') : t('open-sidebar')"
            @click.stop="$emit('toggleSidebar')"
          >
            <span class="sr-only">{{ props.sidebarOpen ? t('close-sidebar') : t('open-sidebar') }}</span>
            <IconMenu class="w-6 h-6 fill-current" />
          </button>

          <!-- Title on desktop -->
          <div class="hidden lg:block">
            <div class="font-bold truncate text-md md:text-2xl text-dark dark:text-white flex items-center space-x-2">
              <nav v-if="$route.path !== '/' && $route.path !== '/app'" class="text-sm text-slate-600 dark:text-slate-400 font-normal" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1">
                  <li>
                    <router-link
                      to="/"
                      class="first-letter:uppercase hover:underline focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 rounded-sm px-1"
                    >
                      {{ t('home') }}
                    </router-link>
                  </li>
                  <li v-for="(breadcrumb, i) in displayStore.pathTitle" :key="i" class="flex items-center">
                    <span class="mx-1" aria-hidden="true"> / </span>
                    <router-link
                      :to="breadcrumb.path"
                      class="first-letter:uppercase hover:underline focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 rounded-sm px-1"
                    >
                      {{ breadcrumb.name.includes('.') ? breadcrumb.name : t(breadcrumb.name) }}
                    </router-link>
                  </li>
                  <li v-if="displayStore.NavTitle" class="flex items-center">
                    <span class="mx-1" aria-hidden="true"> / </span>
                  </li>
                </ol>
              </nav>
              <span class="first-letter:uppercase">{{ displayStore.NavTitle }}</span>
            </div>
          </div>
        </div>

        <!-- Centered title on mobile -->
        <div class="flex-1 px-4 text-center lg:hidden">
          <div class="font-bold truncate text-md text-dark dark:text-white first-letter:uppercase">
            {{ displayStore.NavTitle }}
          </div>
        </div>

        <!-- Right side: Desktop banner -->
        <div class="hidden lg:flex">
          <Banner desktop />
        </div>

        <!-- Mobile banner in navbar -->
        <div class="lg:hidden">
          <Banner desktop />
        </div>
      </div>
    </div>
  </header>
</template>
