<script setup lang="ts">
import { ref } from 'vue'
import { useI18n } from 'vue-i18n'
import { toast } from 'vue-sonner'
import copy from 'copy-text-to-clipboard'
import { useSupabase } from '~/services/supabase'
import type { Database } from '~/types/supabase.types'
import { useMainStore } from '~/stores/main'
import { useDisplayStore } from '~/stores/display'
import Plus from '~icons/heroicons/plus'
import Trash from '~icons/heroicons/trash'
import Pencil from '~icons/heroicons/pencil'
import ArrowPath from '~icons/heroicons/arrow-path'
import Clipboard from '~icons/heroicons/clipboard-document'

const { t } = useI18n()
const displayStore = useDisplayStore()
const main = useMainStore()
const isLoading = ref(false)
const supabase = useSupabase()
const keys = ref<Database['public']['Tables']['apikeys']['Row'][]>()
const magicVal = ref(0)
async function getKeys(retry = true): Promise<void> {
  isLoading.value = true
  const { data } = await supabase
    .from('apikeys')
    .select()
    .eq('user_id', main.user?.id)
  if (data && data.length)
    keys.value = data

  else if (retry && main.user?.id)
    return getKeys(false)

  isLoading.value = false
}
displayStore.NavTitle = ''
getKeys()

async function addNewApiKey() {
  if (await showAddNewKeyModal())
    return

  const keyType = displayStore.lastButtonRole

  let databaseKeyType: 'read' | 'write' | 'all' | 'upload'

  switch (keyType) {
    case 'cancel':
    case '':
      return
    case 'read-button':
      databaseKeyType = 'read'
      break
    case 'upload-button':
      databaseKeyType = 'upload'
      break
    case 'write-button':
      databaseKeyType = 'write'
      break
    case 'all-button':
      databaseKeyType = 'all'
      break
    default:
      return
  }

  const newApiKey = crypto.randomUUID()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    console.log('Not logged in, cannot regenerate API key')
    return
  }

  const { data, error } = await supabase
    .from('apikeys')
    .upsert({ user_id: user.id, key: newApiKey, mode: databaseKeyType })
    .select()

  if (error)
    throw error

  keys.value?.push(data[0])
  toast.success(t('add-api-key'))
}

async function regenrateKey(app: Database['public']['Tables']['apikeys']['Row']) {
  if (await showRegenerateKeyModal())
    return

  const newApiKey = crypto.randomUUID()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    console.log('Not logged in, cannot regenerate API key')
    return
  }

  const { error } = await supabase
    .from('apikeys')
    .update({ key: newApiKey })
    .eq('user_id', user.id)
    .eq('key', app.key)

  if (error || typeof newApiKey !== 'string')
    throw error

  app.key = newApiKey

  toast.success(t('generated-new-apikey'))
}

async function deleteKey(key: Database['public']['Tables']['apikeys']['Row']) {
  if (await showDeleteKeyModal())
    return

  const { error } = await supabase
    .from('apikeys')
    .delete()
    .eq('key', key.key)

  if (error)
    throw error

  toast.success(t('removed-apikey'))
  keys.value = keys.value?.filter(filterKey => filterKey.key !== app.key)
}

async function changeName(key: Database['public']['Tables']['apikeys']['Row']) {
  const currentName = key.name

  displayStore.dialogOption = {
    header: t('change-api-key-name'),
    message: `${t('type-new-name')}`,
    input: true,
    headerStyle: 'w-full text-center',
    textStyle: 'w-full text-center',
    size: 'max-w-lg',
    buttonCenter: true,
    buttons: [
      {
        text: t('button-cancel'),
        role: 'cancel',
      },
      {
        text: t('button-confirm'),
        id: 'confirm-button',
        handler: async () => {
          const newName = displayStore.dialogInputText
          if (currentName === newName) {
            toast.error(t('new-name-not-changed'))
            return
          }

          if (newName.length > 32) {
            toast.error(t('new-name-to-long'))
            return
          }

          const { error } = await supabase.from('apikeys')
            .update({ name: newName })
            .eq('id', key.id)

          if (error) {
            toast.error(t('cannot-change-name'))
            console.error(error)
            return
          }

          toast.success(t('changed-name'))
          keys.value = keys.value?.map((k) => {
            if (key.id === k.id)
              k.name = newName

            return k
          })
          magicVal.value += 1
        },
      },
    ],
  }
  displayStore.showDialog = true
  return displayStore.onDialogDismiss()
}

// This returns true if user has canceled the action
async function showRegenerateKeyModal() {
  displayStore.dialogOption = {
    header: t('alert-confirm-regenerate'),
    message: `${t('alert-not-reverse-message')}. ${t('alert-regenerate-key')}?`,
    buttons: [
      {
        text: t('button-cancel'),
        role: 'cancel',
      },
      {
        text: t('button-regenerate'),
        id: 'confirm-button',
      },
    ],
  }
  displayStore.showDialog = true
  return displayStore.onDialogDismiss()
}

async function showDeleteKeyModal() {
  displayStore.dialogOption = {
    header: t('alert-confirm-delete'),
    message: `${t('alert-not-reverse-message')} ${t('alert-delete-message')}?`,
    buttons: [
      {
        text: t('button-cancel'),
        role: 'cancel',
      },
      {
        text: t('button-delete'),
        id: 'confirm-button',
      },
    ],
  }
  displayStore.showDialog = true
  return displayStore.onDialogDismiss()
}

async function showAddNewKeyModal() {
  displayStore.dialogOption = {
    header: t('alert-add-new-key'),
    message: t('alert-generate-new-key'),
    buttons: [
      {
        text: t('button-cancel'),
        role: 'cancel',
      },
      {
        text: t('key-read'),
        id: 'read-button',
      },
      {
        text: t('key-upload'),
        id: 'upload-button',
      },
      {
        text: t('write-key'),
        id: 'write-button',
      },
      {
        text: t('key-all'),
        id: 'all-button',
      },
    ],
  }
  displayStore.showDialog = true
  return displayStore.onDialogDismiss()
}

async function copyKey(app: Database['public']['Tables']['apikeys']['Row']) {
  copy(app.key)
  console.log('displayStore.messageToast', displayStore.messageToast)
  toast.success(t('key-copied'))
}
</script>

<template>
  <div class="w-full h-full px-4 py-8 mx-auto max-w-9xl lg:px-8 sm:px-6">
    <!-- Page header -->
    <div class="mb-6 flex flex-row w-[66.666667%] ml-auto mr-auto">
      <!-- Title -->
      <h1 class="ml-2 text-2xl font-bold text-slate-800 md:text-3xl dark:text-white">
        CLI {{ t('api-keys') }}
      </h1>
      <button class="ml-auto mr-2 " @click="addNewApiKey()">
        <Plus class="text-green-500" />
      </button>
    </div>
    <div class="flex flex-col">
      <div class="flex flex-col overflow-hidden overflow-y-auto bg-white shadow-lg border-slate-200 md:mx-auto md:mt-5 md:w-2/3 md:border dark:border-slate-900 md:rounded-lg dark:bg-slate-800">
        <dl :key="magicVal" class="divide-y divide-gray-500">
          <InfoRow v-for="key in keys" :key="key.id" :label="key.mode.toUpperCase()" :value="key.name" :is-link="true">
            <button class="ml-auto bg-transparent w-7 h-7" @click="regenrateKey(key)">
              <ArrowPath class="mr-4 text-lg" />
            </button>
            <button class="ml-auto bg-transparent w-7 h-7" @click="changeName(key)">
              <Pencil class="mr-4 text-lg" />
            </button>
            <button class="ml-auto bg-transparent w-7 h-7" @click="copyKey(key)">
              <Clipboard class="mr-4 text-lg" />
            </button>
            <button class="ml-4 bg-transparent w-7 h-7" @click="deleteKey(key)">
              <Trash class="mr-4 text-lg text-red-600" />
            </button>
          </InfoRow>
        </dl>
      </div>
    </div>
  </div>
</template>
